# EC2
Elastic Compute Cloud
- 클라우드의 가장 핵심 기술은 원할 때마다 컴퓨터 자원을 임대해주는 On-Demand이다.
- EC2는 CPU, RAM, Storage, 네트워크 등 컴퓨터 자원을 가상머신으로 제공해주는 서비스이다.
- 직접 사용할 운영체제 종류를 선택할 수 있어서, IaaS (Infrastructure as a Service) 이다.

## EC2 User Data
- 인스턴스를 부트스트래핑할 때 사용되는 스크립트
- 부트스트래핑이란, 컴퓨터를 부팅할 때 최초로 실행되는 것을 말한다.
- 즉, EC2 가상머신을 처음 생성할 때 부팅과정에서 실행되는 스크립트이다.
- 따라서 가상머신을 처음 구성할 때 필요한 작업을 정의한다.
  - 업데이트, 소프트웨어 설치 등
- 루트 계정에서 실행되므로 모든 명령문은 sudo로 해야한다.

*User Data 예시*
```
sudo apt update
sudo apt install git docker
```
<br/>

## EC2 인스턴스 유형
1. 범용 목적
    - 웹 서버, 코드 저장소 같은 일반적인 작업에 적합
    - 컴퓨팅 성능, 메모리, 네트워킹 간의 균형이 잘 맞다.

2. 컴퓨팅 최적화
    - 고성능의 CPU와 컴퓨팅 작업이 필요한 작업에 적합
    - 데이터 일괄 처리, 미디어 트랜스코딩 작업, 고성능 웹 서버, 고성능 컴퓨팅 작업, 머신러닝 등에 사용

3. 메모리 최적화
    - 메모리에서 대규모 데이터셋을 처리하는 작업에 적합
    - 고성능의 데이터베이스, 비지니스 분석에 최적화된 인메모리 데이터베이스, 대규모 비정형 데이터의 실시간 처리 등에 사용

4. 가속 컴퓨팅

5. 스토리지 최적화
    - 로컬 스토리지에서 대규모의 데이터셋에 액세스할 때 적합
    - OLTP 시스템, NoSQL 데이터베이스 등에 사용

6. HPC 최적화
    - High Performance Computing 작업에 적합

<br/>

## 보안 그룹
- EC2 인스턴스에 들어오고 나가는 트래픽을 제어하기 위한 방화벽
- `인바운드 규칙`: EC2 인스턴스로 들어오는 트래픽
    - 모든 트래픽을 허용하지 않는 것이 디폴트 값이다.
- `아웃바운드 규칙`: EC2 인스턴스에서 나가는 트래픽
    - 모든 트래픽을 허용하는 것이 디폴트 값이다.
- 특정 IP 주소, 포트 번호를 정의하여 트래픽을 허용할 수 있다.
- 보안 그룹은 허용하는 규칙밖에 정의할 수 없다. 그래서 보안 그룹에서 명시적으로 허용하지 않는다면 해당 트래픽은 접근할 수 없다.
- 다른 보안 그룹도 허용할 수 있는데, 이 경우에는 허용한 보안 그룹에서 들어오는 트래픽만 허용된다.
    - 특정 로드 밸런서에서만 트래픽을 받고싶은 경우, EC2 인스턴스의 보안 그룹에서 로드 밸런서의 보안 그룹을 허용해주면 된다.
- 특정 가용영역에서만 정의된다.

*예시*
![image](https://github.com/Ohjiwoo-lab/aws-architecture-study/assets/74577768/b102b5cb-1f17-4811-8980-614f4127fbab)
- 인바운드 규칙으로 ssh를 통해 접근하는 트래픽을 허용해주었다.
- 또한 자기 자신의 보안 그룹을 허용해줌으로써, 서로 다른 EC2 인스턴스이지만 같은 보안 그룹을 사용할 때, 인스턴스 간 통신할 수 있도록 설정하였다.

### Classic Ports to Know
- 22 - SSH (리눅스 인스턴스에 로그인)
- 21 - FTP (파일 공유 시스템에 파일을 업로드)
- 22 - SFTP (SSH를 사용하여 파일을 업로드. 그래서 SSH와 같은 포트를 사용)
- 80 - HTTP (보안이 되지 않는 사이트에 액세스)
- 443 - HTTPS (보안 사이트에 액세스)
- 3389 - RDP (윈도우 인스턴스에 로그인)

<br/>

## 인스턴스 구매 옵션

### 온디맨드 EC2 인스턴스
- 필요한 만큼 인스턴스를 사용하고, 사용한 만큼 비용을 지불
- 비용 예측이 쉽지만 초 단위로 요금을 지불하기 때문에 가장 비용이 비싸다.
- 단기적이고 사용량이 예측되지 않는 워크로드에 적합하다.

### 예약 인스턴스
- 온디맨드 인스턴스보다 72% 가까이 할인된다.
- 인스턴스 타입, 리전, 테넌시, OS 등을 미리 예약하고, 기간을 1년 또는 3년으로 지정한다.
- 지정된 기간동안 예약된 인스턴스를 적은 비용으로 사용할 수 있다.
- 데이터베이스와 같이 사용되는 리전, 사용량이 일정한 워크로드에 적합

### EC2 절약 플랜
- 장기간 사용하면 할인을 받을 수 있는 인스턴스이다.
- 시간 당 약정 금액을 지정할 수 있으며, 사용량이 미리 지정한 한도를 넘어가면 온디맨드 가격으로 비용이 청구된다.
- 특정한 인스턴스 타입, 리전을 미리 지정해야 한다.

### 스팟 인스턴스
- 온디맨드 인스턴스에 비해 90%까지 할인된다.
- 지불하려고 하는 최대 스팟 가격을 미리 정의하고, 만약 실제 사용 가격이 최대 스팟 가격보다 낮다면 인스턴스가 계속 유지된다.
- 하지만 가격이 최대 스팟 가격보다 넘어가면 2가지 옵션 중에 선택해야 한다.
  - 인스턴스를 중지했다가, 가격이 다시 최대 스팟 가격보다 낮아진다면 다시 인스턴스를 시작하는 옵션
  - 인스턴스를 아예 종료시키는 옵션 (더 이상 사용할 수 없다.)
- 언제라도 인스턴스가 삭제될 수 있는 위험성이 존재한다.
- 배치 작업이나 데이터 분석, 이미지 처리, 장애에 대한 회복력이 좋은 워크로드에 적합
- 데이터베이스 같은 데이터 보존이 중요한 작업에는 적합하지 않다.

#### 요청 유형
- 일회성 요청
  - 스팟 요청이 완료되는 즉시 인스턴스가 시작되며, 요청은 사라진다.
  - 만약 인스턴스가 어떤 이유로 종료가 되면, 다시 새로운 스팟 인스턴스를 생성해야 한다.
- 영구 요청
  - 스팟 인스턴스가 시작되더라도 스팟 요청은 유지된다.
  - 그래서 스팟 인스턴스가 종료되었더라도 요청이 유효하다면, 해당 스팟 요청에 의해 인스턴스가 자동으로 다시 시작된다.
  - 그래서 인스턴스를 완전히 종료하고 싶다면 스팟 요청을 취소한 뒤, 스팟 인스턴스를 종료해야 한다.

#### 스팟 플릿
- 미리 정의한 최대 가격 내에서 목표 용량을 충족하기 위해 스팟 인스턴스 세트를 구성해주는 것이다.
- 다양한 인스턴스 유형으로 여러 런치 풀을 생성한 뒤, 그 중 가장 적합한 런치 풀을 선택한다.
- 스팟 인스턴스를 할당하는 전략
  - 최저 가격: 가장 낮은 가격으로 구성한다. 워크로드가 매우 짧은 경우 적합하다.
  - 분산 배치: 인스턴스가 정의한 모든 런치 풀에 분산되어 실행된다. 워크로드가 긴 경우와 높은 가용성을 요구하는 경우에 적합하다.
  - 용량 최적화: 사용 가능한 용량이 가장 큰 런치 풀 중에 가격이 가장 낮은 풀을 선택한다. 대부분의 워크로드에 적합하다.

### EC2 전용 호스트
- 전용 물리적 서버를 할당받는 것이다.
- 법규 준수가 요구되거나, 라이선스를 가지고 있는 소프트웨어를 사용하는 경우에 적합하다.
- 회사의 전용 서버에서 실행되는 소프트웨어가 엄격한 사내 규정을 준수해야하는 경우 유용하다.
- 온디맨드 방식으로 초당 비용을 지불하거나, 1년 또는 3년 동안 예약할 수 있다.
- 가장 비싼 옵션이다.

### EC2 전용 인스턴스
- 전용 하드웨어를 할당받는 것이다.
- AWS에서 인스턴스 배치를 자동으로 해주기 때문에, 인스턴스 배치에 대한 통제권은 없다.
- 원하는 인스턴스에 해당하는 만큼 자신만의 하드웨어를 가지게 되는 방식이다.

### EC2 용량 예약
- 원하는 기간동안 특정한 리전에 온디맨드 인스턴스의 용량을 예약할 수 있다.
- 기간 약정은 없다.
- 인스턴스를 실제로 실행하는 지에 상관없이 예약하고 있는 동안에는 온디맨드 요금이 부과된다.
- 특정한 리전에 있어야만 하는 단기적이고 중단 없는 워크로드에 적합하다.

<br/>

## 배치 그룹
- EC2 인스턴스가 데이터센터에 배치되는 방식

### 클러스터 배치 그룹
![image](https://github.com/Ohjiwoo-lab/aws-architecture-study/assets/74577768/68c9e2fd-2cbd-46db-8a33-db12fee6b221)

- 단일 가용 영역 내에 모든 인스턴스를 그룹화하여 배치하는 방식이다.
- 모든 인스터스가 동일한 가용 영역의 동일한 하드웨어 랙에 배치된다.
- 그래서 인스턴스 간에 직접적으로 연결되기 때문에 지연시간이 짧다.
- 하지만 하드웨어에 문제가 발생하면 모든 EC2 인스턴스가 영향을 받는다.
- 높은 대역폭과 짧은 지연 시간을 필요로 하는 빅데이터 분석 같은 작업에 적합하다.

### 분산 배치 그룹
![image](https://github.com/Ohjiwoo-lab/aws-architecture-study/assets/74577768/ee02a1a3-d7b4-4fde-8128-e3f04dae6ec3)

- 모든 인스턴스가 서로 다른 하드웨어 랙에 배치되는 방시기이다.
- 즉, 하나의 하드웨어에 하나의 EC2 인스턴스가 들어가는 것이다.
- 가용 영역별로 랙이 7개까지 존재할 수 있으므로, 하나의 가용 영역에는 총 7개의 인스턴스가 배치될 수 있다.
- 가용성을 극대화하고, 하드웨어 장애로부터 위험성을 최소화해야하는 경우에 적합하다.

### 분할 배치 그룹
![image](https://github.com/Ohjiwoo-lab/aws-architecture-study/assets/74577768/1627a076-6787-4099-b97a-04ee35fe3a85)

- 인스턴스를 파티션을 기준으로 분할하여 분산시키는 방식이다.
- 파티션은 하나의 하드웨어 랙이라고 생각하면 된다. 즉 하나의 하드웨어에 여러 EC2 인스턴스를 배치하긴 하지만, 분산 배치 그룹처럼 인스턴스를 분산시키기 위한 배치 그룹이다.
- 가용 영역별로 7개의 파티션이 존재할 수 있고, 파티션 내에는 여러 개의 EC2 인스턴스가 배치된다.
- 여러 하드웨어로 인스턴스를 분산하여 장애로부터의 위험을 최소화하면서도, 파티션 내에 최대 수백 개의 EC2 인스턴스를 배치할 수 있다는 점에서 클러스터 배치 그룹과 분산 배치 그룹의 장점만을 취합한 방식이라고 할 수 있다.
- 파티션 인식이 가능한 Hadoop, Cassandra, Kafka 같은 서비스에 적합하다.
- EC2 인스턴스가 어떤 파티션에 있는 지 알기 위해 메타데이터 서비스를 이용한다.

<hr/>

> 이는 Udemy - AWS Solution Architect Associate C-03 강의를 들으면서 공부한 내용을 바탕으로 하고있습니다.   
> 이미지 출처: https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/placement-groups.html
